version: "3"

tasks:
  deps:
    desc: Install dependencies (Java and Copybara) if not already installed
    cmds:
      - task: _check_java
      - task: _install_copybara

  _check_java:
    internal: true
    desc: Check and install Java if not already installed
    cmds:
      - |
        if command -v java &> /dev/null; then
          echo "‚úÖ Java is already installed: $(java -version 2>&1 | head -n 1)"
        else
          echo "üì¶ Java not found, installing..."
          
          # Detect OS
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          
          case "$OS" in
            linux)
              # Check if we're in GitHub Actions or similar CI
              if [ -n "$GITHUB_ACTIONS" ] || [ -n "$CI" ]; then
                echo "üîÑ Installing Java in CI environment..."
                sudo apt-get update -qq
                sudo apt-get install -y openjdk-11-jdk
              else
                # Try to detect the Linux distribution
                if command -v apt-get &> /dev/null; then
                  echo "üîÑ Installing Java on Debian/Ubuntu..."
                  sudo apt-get update
                  sudo apt-get install -y openjdk-11-jdk
                elif command -v yum &> /dev/null; then
                  echo "üîÑ Installing Java on RHEL/CentOS..."
                  sudo yum install -y java-11-openjdk-devel
                elif command -v dnf &> /dev/null; then
                  echo "üîÑ Installing Java on Fedora..."
                  sudo dnf install -y java-11-openjdk-devel
                else
                  echo "‚ùå Unable to auto-install Java on this Linux distribution"
                  echo "üìù Please install Java 11+ manually and retry"
                  exit 1
                fi
              fi
              ;;
            darwin)
              if command -v brew &> /dev/null; then
                echo "üîÑ Installing Java on macOS via Homebrew..."
                brew install openjdk@11
                # Add to PATH for current session
                export PATH="/opt/homebrew/opt/openjdk@11/bin:$PATH"
              else
                echo "‚ùå Homebrew not found on macOS"
                echo "üìù Please install Homebrew first: /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
                echo "üìù Or download Java from: https://adoptium.net/"
                exit 1
              fi
              ;;
            *)
              echo "‚ùå Unsupported operating system: $OS"
              echo "üìù Please install Java 11+ manually from: https://adoptium.net/"
              exit 1
              ;;
          esac
          
          # Verify installation
          if command -v java &> /dev/null; then
            echo "‚úÖ Java installed successfully: $(java -version 2>&1 | head -n 1)"
          else
            echo "‚ùå Java installation failed"
            exit 1
          fi
        fi

  _install_copybara:
    internal: true
    desc: Install Copybara if not already installed
    vars:
      INSTALL_DIR: "/usr/local/bin"
    cmds:
      - |
        if command -v copybara &> /dev/null; then
          echo "‚úÖ Copybara is already installed"
        else
          echo "üì¶ Installing Copybara from source..."
          
          # Check if Bazel is installed
          if ! command -v bazel &> /dev/null; then
            echo "üîÑ Installing Bazel first..."
            
            # Install Bazel for Ubuntu/Debian
            if command -v apt-get &> /dev/null; then
              sudo apt-get update -qq
              sudo apt-get install -y apt-transport-https curl gnupg
              curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/bazel.gpg > /dev/null
              echo "deb [arch=amd64] https://storage.googleapis.com/bazel-apt stable jdk1.8" | sudo tee /etc/apt/sources.list.d/bazel.list
              sudo apt-get update -qq
              sudo apt-get install -y bazel
            else
              echo "‚ùå Unable to install Bazel automatically on this system"
              echo "üìù Please install Bazel manually: https://bazel.build/install"
              exit 1
            fi
          else
            echo "‚úÖ Bazel is already installed"
          fi
          
          # Create temporary directory and build Copybara
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          echo "üîÑ Cloning Copybara repository..."
          git clone https://github.com/google/copybara.git
          cd copybara
          
          echo "üî® Building Copybara with Bazel (this may take a few minutes)..."
          bazel build //java/com/google/copybara
          
          # Install the binary
          echo "üì¶ Installing Copybara to {{.INSTALL_DIR}}..."
          sudo cp -f bazel-bin/java/com/google/copybara/copybara {{.INSTALL_DIR}}/copybara
          sudo chmod +x {{.INSTALL_DIR}}/copybara
          
          # Cleanup
          cd /
          rm -rf "$TEMP_DIR"
          
          echo "‚úÖ Copybara installed successfully!"
        fi

  push:
    desc: Run Copybara mirror with force
    deps: [deps]
    vars:
      ROOT_DIR: "../../.."
    cmds:
      - cd {{.ROOT_DIR}} && copybara copy.bara.sky world-cli --force

  dry-run:
    desc: Run Copybara dry-run to see what would be copied
    deps: [deps]
    vars:
      ROOT_DIR: "../../.."
    cmds:
      - cd {{.ROOT_DIR}} && copybara copy.bara.sky world-cli --dry-run
