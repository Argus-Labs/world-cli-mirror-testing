version: "3"

tasks:
  deps:
    desc: Install dependencies (Java and Copybara) if not already installed
    cmds:
      - task: _check_java
      - task: _install_copybara

  _check_java:
    internal: true
    desc: Check and install Java if not already installed
    cmds:
      - |
        if command -v java &> /dev/null; then
          echo "‚úÖ Java is already installed: $(java -version 2>&1 | head -n 1)"
        else
          echo "üì¶ Java not found, installing..."
          
          # Detect OS
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          
          case "$OS" in
            linux)
              # Check if we're in GitHub Actions or similar CI
              if [ -n "$GITHUB_ACTIONS" ] || [ -n "$CI" ]; then
                echo "üîÑ Installing Java in CI environment..."
                sudo apt-get update -qq
                sudo apt-get install -y openjdk-11-jdk
              else
                # Try to detect the Linux distribution
                if command -v apt-get &> /dev/null; then
                  echo "üîÑ Installing Java on Debian/Ubuntu..."
                  sudo apt-get update
                  sudo apt-get install -y openjdk-11-jdk
                elif command -v yum &> /dev/null; then
                  echo "üîÑ Installing Java on RHEL/CentOS..."
                  sudo yum install -y java-11-openjdk-devel
                elif command -v dnf &> /dev/null; then
                  echo "üîÑ Installing Java on Fedora..."
                  sudo dnf install -y java-11-openjdk-devel
                else
                  echo "‚ùå Unable to auto-install Java on this Linux distribution"
                  echo "üìù Please install Java 11+ manually and retry"
                  exit 1
                fi
              fi
              ;;
            darwin)
              if command -v brew &> /dev/null; then
                echo "üîÑ Installing Java on macOS via Homebrew..."
                brew install openjdk@11
                # Add to PATH for current session
                export PATH="/opt/homebrew/opt/openjdk@11/bin:$PATH"
              else
                echo "‚ùå Homebrew not found on macOS"
                echo "üìù Please install Homebrew first: /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
                echo "üìù Or download Java from: https://adoptium.net/"
                exit 1
              fi
              ;;
            *)
              echo "‚ùå Unsupported operating system: $OS"
              echo "üìù Please install Java 11+ manually from: https://adoptium.net/"
              exit 1
              ;;
          esac
          
          # Verify installation
          if command -v java &> /dev/null; then
            echo "‚úÖ Java installed successfully: $(java -version 2>&1 | head -n 1)"
          else
            echo "‚ùå Java installation failed"
            exit 1
          fi
        fi

  _install_copybara:
    internal: true
    desc: Install Copybara if not already installed
    vars:
      COPYBARA_VERSION: "v20250714"
      INSTALL_DIR: "/usr/local/bin"
    cmds:
      - |
        if command -v copybara &> /dev/null; then
          echo "‚úÖ Copybara is already installed"
        else
          echo "üì¶ Installing Copybara..."
          
          # Detect OS and architecture
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)
          
          case "$ARCH" in
            x86_64) ARCH="amd64" ;;
            aarch64|arm64) ARCH="arm64" ;;
            *) echo "‚ùå Unsupported architecture: $ARCH"; exit 1 ;;
          esac
          
          # Try downloading pre-built binary
          BINARY_URL="https://github.com/google/copybara/releases/download/{{.COPYBARA_VERSION}}/copybara_${OS}_${ARCH}"
          
          echo "üîÑ Downloading Copybara binary..."
          if curl -L -f "$BINARY_URL" -o /tmp/copybara 2>/dev/null; then
            echo "üì¶ Installing Copybara to {{.INSTALL_DIR}}..."
            sudo mv /tmp/copybara {{.INSTALL_DIR}}/copybara
            sudo chmod +x {{.INSTALL_DIR}}/copybara
            echo "‚úÖ Copybara installed successfully!"
          else
            echo "‚ùå Pre-built binary not available for $OS/$ARCH"
            echo "üìù Please install Copybara manually:"
            echo "   1. Install Bazel: https://bazel.build/install"
            echo "   2. Clone repo: git clone https://github.com/google/copybara.git"
            echo "   3. Build: cd copybara && bazel build //java/com/google/copybara"
            echo "   4. Install: sudo cp bazel-bin/java/com/google/copybara/copybara {{.INSTALL_DIR}}/"
            exit 1
          fi
        fi

  push:
    desc: Run Copybara mirror with force
    deps: [deps]
    vars:
      ROOT_DIR: "../../.."
    cmds:
      - cd {{.ROOT_DIR}} && copybara copy.bara.sky world-cli --force

  dry-run:
    desc: Run Copybara dry-run to see what would be copied
    deps: [deps]
    vars:
      ROOT_DIR: "../../.."
    cmds:
      - cd {{.ROOT_DIR}} && copybara copy.bara.sky world-cli --dry-run
